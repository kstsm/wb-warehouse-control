<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WarehouseControl</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;padding:20px}
        .container{max-width:1400px;margin:0 auto}
        .login-container{max-width:400px;margin:50px auto}
        h1{margin-bottom:30px;color:#222;text-align:center}
        .section{background:#fff;padding:20px;border-radius:8px;margin-bottom:16px;border:1px solid #e6e6e6}
        h2{margin-bottom:16px;color:#222;font-size:20px}
        .form-group{margin:12px 0}
        label{display:block;margin-bottom:6px;font-weight:600;color:#555}
        input,select,button,textarea{padding:8px;border-radius:6px;border:1px solid #dcdcdc;font-size:14px;width:100%;max-width:100%;box-sizing:border-box}
        textarea{resize:vertical;min-height:60px}
        button.btn{background:#007bff;color:#fff;border:none;cursor:pointer;padding:10px 14px;width:auto}
        button.btn:hover{background:#0056b3}
        button.secondary{background:#6c757d;color:#fff}
        button.secondary:hover{background:#5a6268}
        button.danger{background:#dc3545;color:#fff}
        button.danger:hover{background:#c82333}
        button.small{padding:4px 8px;font-size:12px;font-weight:normal}
        .error{color:#dc3545;padding:10px;background:#f8d7da;border-radius:4px;margin-bottom:20px;display:none}
        .success{color:#155724;padding:10px;background:#d4edda;border-radius:4px;margin-bottom:20px;display:none}
        .filters{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:10px}
        .filters .form-group{flex:1;min-width:150px}
        .table-container{overflow-x:auto;margin-top:16px}
        table{width:100%;border-collapse:collapse}
        th,td{padding:10px;text-align:left;border-bottom:1px solid #e6e6e6}
        th{background:#f8f9fa;font-weight:600;color:#555}
        tr:hover{background:#f8f9fa}
        .actions{display:flex;gap:8px}
        .actions button{padding:6px 12px;font-size:13px;width:auto}
        .empty-state{text-align:center;padding:40px;color:#999}
        .form-row{display:flex;gap:12px;flex-wrap:wrap}
        .form-row .form-group{flex:1;min-width:200px;max-width:100%;overflow:hidden}
        .button-group{display:flex;gap:8px;margin-top:12px;margin-bottom:12px}
        .badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600}
        .badge-admin{background:#dc3545;color:#fff}
        .badge-manager{background:#ffc107;color:#000}
        .badge-viewer{background:#28a745;color:#fff}
        .diff-table{margin-top:10px}
        .diff-table td{font-size:12px;padding:4px}
        .hidden{display:none}
    </style>
</head>
<body>
<div id="loginView" class="login-container">
    <h1>WarehouseControl</h1>
    <div class="section">
        <h2>Вход в систему</h2>
        <div id="message"></div>
        <div class="form-group">
            <label for="userId">Имя пользователя</label>
            <input id="userId" autocomplete="off">
        </div>
        <div class="form-group">
            <label for="userRole">Роль</label>
            <select id="userRole">
                <option value="admin">Admin - полный доступ</option>
                <option value="manager">Manager - просмотр и редактирование</option>
                <option value="viewer">Viewer - только просмотр</option>
            </select>
        </div>
        <button class="btn" onclick="login()">Войти</button>
    </div>
</div>

<div id="appView" class="container hidden">
    <h1>WarehouseControl</h1>
    <div style="margin-bottom:20px">
        <span id="roleBadge" class="badge"></span>
        <span style="margin-left:10px" id="userInfo"></span>
        <button class="btn secondary" style="float:right" onclick="logout()">Выйти</button>
    </div>
    <div id="message"></div>

    <div id="itemsSection" class="section hidden">
        <h2>Добавить товар</h2>
        <form id="itemForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="name">Название</label>
                    <input type="text" id="name">
                </div>
                <div class="form-group">
                    <label for="description">Описание</label>
                    <textarea id="description" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="quantity">Количество</label>
                    <input id="quantity">
                </div>
                <div class="form-group">
                    <label for="price">Цена (копейки)</label>
                    <input id="price">
                </div>
            </div>
            <div style="margin-top:12px">
                <button type="submit" class="btn">Добавить товар</button>
            </div>
        </form>
    </div>

    <div id="editSection" class="section hidden">
        <h2>Редактировать товар</h2>
        <form id="editForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="editName">Название</label>
                    <input type="text" id="editName">
                </div>
                <div class="form-group">
                    <label for="editDescription">Описание</label>
                    <textarea id="editDescription" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="editQuantity">Количество</label>
                    <input id="editQuantity" >
                </div>
                <div class="form-group">
                    <label for="editPrice">Цена (копейки)</label>
                    <input  id="editPrice">
                </div>
            </div>
            <div class="button-group">
                <button type="submit" class="btn">Сохранить изменения</button>
                <button type="button" class="secondary" onclick="cancelEdit()">Отмена</button>
            </div>
        </form>
    </div>

    <div class="section">
        <h2>Список товаров</h2>
        <div class="button-group">
            <button class="btn" onclick="loadItems()">Обновить список</button>
        </div>
        
        <div class="table-container">
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Описание</th>
                        <th>Количество</th>
                        <th>Цена</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <tr>
                        <td colspan="5" class="loading">Загрузка...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>История изменений</h2>
        <div class="filters">
            <div class="form-group">
                <label for="historyItemId">ID товара</label>
                <input type="text" id="historyItemId" placeholder="UUID">
            </div>
            <div class="form-group">
                <label for="historyUserId">ID пользователя</label>
                <input id="historyUserId" placeholder="UUID">
            </div>
            <div class="form-group">
                <label for="historyAction">Действие</label>
                <select id="historyAction">
                    <option value="">Все</option>
                    <option value="create">Создание</option>
                    <option value="update">Обновление</option>
                    <option value="delete">Удаление</option>
                </select>
            </div>
            <div class="form-group">
                <label for="historyFrom">От</label>
                <input type="datetime-local" id="historyFrom">
            </div>
            <div class="form-group">
                <label for="historyTo">До</label>
                <input type="datetime-local" id="historyTo">
            </div>
        </div>
        <div class="button-group">
            <button class="btn" onclick="loadHistory()">Применить фильтры</button>
            <button class="secondary" onclick="exportHistory()">Экспорт в CSV</button>
        </div>
        
        <div class="table-container">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>ID товара</th>
                        <th>Действие</th>
                        <th>Пользователь</th>
                        <th>Дата</th>
                        <th>Изменения</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="5" class="loading">Загрузка...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let token = localStorage.getItem('token');
    let currentRole = localStorage.getItem('role');
    let currentUserId = localStorage.getItem('userId');
    let editingItemId = null;

    window.onload = function() {
        const savedToken = localStorage.getItem('token');
        const savedRole = localStorage.getItem('role');
        const savedUserId = localStorage.getItem('userId');
        
        if (savedToken && savedRole) {
            token = savedToken;
            currentRole = savedRole;
            currentUserId = savedUserId;
            showApp();
        } else {
            showLogin();
        }
    };

    function showLogin() {
        document.getElementById('loginView').classList.remove('hidden');
        document.getElementById('appView').classList.add('hidden');
    }

    function showApp() {
        document.getElementById('loginView').classList.add('hidden');
        document.getElementById('appView').classList.remove('hidden');
        
        const roleBadge = document.getElementById('roleBadge');
        if (currentRole === 'admin') {
            roleBadge.textContent = 'Admin';
            roleBadge.className = 'badge badge-admin';
        } else if (currentRole === 'manager') {
            roleBadge.textContent = 'Manager';
            roleBadge.className = 'badge badge-manager';
        } else if (currentRole === 'viewer') {
            roleBadge.textContent = 'Viewer';
            roleBadge.className = 'badge badge-viewer';
        }
        
        if (canEdit()) {
            document.getElementById('itemsSection').classList.remove('hidden');
        } else {
            document.getElementById('itemsSection').classList.add('hidden');
        }
        
        document.getElementById('userInfo').textContent = 'Пользователь: ' + (currentUserId || '');
        
        loadItems();
        loadHistory();
    }

    async function login() {
        const userId = document.getElementById('userId').value;
        const role = document.getElementById('userRole').value;

        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_name: userId, role: role })
            });

            const responseText = await response.text();
            let data = null;
            
            if (responseText) {
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    if (!response.ok && responseText) {
                        showMessage(responseText, 'error');
                    }
                    return;
                }
            }

            if (!response.ok) {
                if (data && (data.error || data.Error)) {
                    showMessage(data.error || data.Error, 'error');
                } else if (responseText) {
                    showMessage(responseText, 'error');
                }
                return;
            }

            if (!data || !data.token) {
                if (data && (data.error || data.Error)) {
                    showMessage(data.error || data.Error, 'error');
                }
                return;
            }

            token = data.token;
            currentRole = data.role || role;
            currentUserId = userId;
            
            localStorage.setItem('token', token);
            localStorage.setItem('role', currentRole);
            localStorage.setItem('userId', currentUserId);

            showApp();
        } catch (error) {
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('role');
        localStorage.removeItem('userId');
        token = null;
        currentRole = null;
        currentUserId = null;
        showLogin();
    }

    function getAuthHeaders() {
        const headers = {
            'Content-Type': 'application/json'
        };
        if (token) {
            headers['Authorization'] = 'Bearer ' + token;
        }
        return headers;
    }

    function canEdit() {
        return currentRole === 'admin' || currentRole === 'manager';
    }

    function canDelete() {
        return currentRole === 'admin';
    }

    document.getElementById('itemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            quantity: parseInt(document.getElementById('quantity').value),
            price: parseInt(document.getElementById('price').value)
        };

        try {
            const response = await fetch('/api/items', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const text = await response.text().catch(() => '');
                if (text) {
                    try {
                        const parsed = JSON.parse(text);
                        if (parsed.error || parsed.Error) {
                            showMessage(parsed.error || parsed.Error, 'error');
                        }
                    } catch (e2) {
                        if (text) {
                            showMessage(text, 'error');
                        }
                    }
                }
                return;
            }

            const data = await response.json();
            
            const message = data.message || 'Item created successfully';
            showMessage(message, 'success');

            document.getElementById('itemForm').reset();
            loadItems();
        } catch (error) {
        }
    });

    async function loadItems() {
        try {
            const headers = getAuthHeaders();
            const response = await fetch('/api/items', {
                headers: headers
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    logout();
                    return;
                }
                const text = await response.text().catch(() => '');
                if (text) {
                    try {
                        const parsed = JSON.parse(text);
                        if (parsed.error || parsed.Error) {
                            showMessage(parsed.error || parsed.Error, 'error');
                        }
                    } catch (e2) {
                        if (text) {
                            showMessage(text, 'error');
                        }
                    }
                }
                return;
            }
            
            const data = await response.json();

            const tbody = document.getElementById('itemsTableBody');
            if (data.items && data.items.length > 0) {
                tbody.innerHTML = data.items.map(item => {
                    let actionsHtml = '';
                    if (canEdit()) {
                        actionsHtml += `<button class="secondary" onclick="editItem('${item.id}')">Редактировать</button>`;
                    }
                    if (canDelete()) {
                        actionsHtml += `<button class="danger" onclick="deleteItem('${item.id}')">Удалить</button>`;
                    }
                    actionsHtml += `<button class="btn small" onclick="showItemHistory('${item.id}')">История</button>`;
                    
                    return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.description || ''}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price} ₽</td>
                        <td class="actions">${actionsHtml}</td>
                    </tr>
                `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Нет товаров</td></tr>';
            }
        } catch (error) {
        }
    }

    async function editItem(id) {
        try {
            const response = await fetch(`/api/items/${id}`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                const text = await response.text().catch(() => '');
                if (text) {
                    try {
                        const parsed = JSON.parse(text);
                        if (parsed.error || parsed.Error) {
                            showMessage(parsed.error || parsed.Error, 'error');
                        }
                    } catch (e2) {
                        if (text) {
                            showMessage(text, 'error');
                        }
                    }
                }
                return;
            }
            
            const item = await response.json();

            editingItemId = id;
            document.getElementById('editName').value = item.name;
            document.getElementById('editDescription').value = item.description || '';
            document.getElementById('editQuantity').value = item.quantity;
            const priceParts = item.price.split('.');
            const priceInKopeks = parseInt(priceParts[0]) * 100 + (parseInt(priceParts[1] || '0'));
            document.getElementById('editPrice').value = priceInKopeks;
            document.getElementById('editSection').classList.remove('hidden');
            document.getElementById('itemsSection').classList.add('hidden');
        } catch (error) {
        }
    }

    document.getElementById('editForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!editingItemId) {
            return;
        }

        const formData = {
            name: document.getElementById('editName').value,
            description: document.getElementById('editDescription').value,
            quantity: parseInt(document.getElementById('editQuantity').value),
            price: parseInt(document.getElementById('editPrice').value)
        };

        try {
            const response = await fetch(`/api/items/${editingItemId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const text = await response.text().catch(() => '');
                if (text) {
                    try {
                        const parsed = JSON.parse(text);
                        if (parsed.error || parsed.Error) {
                            showMessage(parsed.error || parsed.Error, 'error');
                        }
                    } catch (e2) {
                        if (text) {
                            showMessage(text, 'error');
                        }
                    }
                }
                return;
            }

            const data = await response.json();
            
            const message = data.message || 'Item updated successfully';
            showMessage(message, 'success');
            
            cancelEdit();
            loadItems();
        } catch (error) {
        }
    });

    function cancelEdit() {
        editingItemId = null;
        document.getElementById('editForm').reset();
        document.getElementById('editSection').classList.add('hidden');
        const itemsSection = document.getElementById('itemsSection');
        if (itemsSection) {
            itemsSection.classList.remove('hidden');
        }
    }

    async function deleteItem(id) {
        if (!confirm('Вы уверены, что хотите удалить этот товар?')) {
            return;
        }

        try {
            const response = await fetch(`/api/items/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const text = await response.text().catch(() => '');
                if (text) {
                    try {
                        const parsed = JSON.parse(text);
                        if (parsed.error || parsed.Error) {
                            showMessage(parsed.error || parsed.Error, 'error');
                        }
                    } catch (e2) {
                        if (text) {
                            showMessage(text, 'error');
                        }
                    }
                }
                return;
            }

            const text = await response.text().catch(() => '');
            let message = 'Item deleted successfully';
            if (text) {
                try {
                    const data = JSON.parse(text);
                    if (data.message) {
                        message = data.message;
                    }
                } catch (e) {
                }
            }
            showMessage(message, 'success');
            loadItems();
        } catch (error) {
        }
    }

    async function loadHistory() {
        const params = new URLSearchParams();
        const itemId = document.getElementById('historyItemId').value;
        const userId = document.getElementById('historyUserId').value;
        const action = document.getElementById('historyAction').value;
        const from = document.getElementById('historyFrom').value;
        const to = document.getElementById('historyTo').value;

        if (itemId) params.append('item_id', itemId);
        if (userId) params.append('user_id', userId);
        if (action) params.append('action', action);
        if (from) params.append('from', new Date(from).toISOString());
        if (to) params.append('to', new Date(to).toISOString());

        try {
            const headers = getAuthHeaders();
            const response = await fetch(`/api/history?${params}`, {
                headers: headers
            });
            if (!response.ok) {
                if (response.status === 401) {
                    logout();
                    return;
                }
                const text = await response.text().catch(() => '');
                if (text) {
                    try {
                        const parsed = JSON.parse(text);
                        if (parsed.error || parsed.Error) {
                            showMessage(parsed.error || parsed.Error, 'error');
                        }
                    } catch (e2) {
                        if (text) {
                            showMessage(text, 'error');
                        }
                    }
                }
                return;
            }

            const data = await response.json();

            const tbody = document.getElementById('historyTableBody');
            if (data.history && data.history.length > 0) {
                tbody.innerHTML = data.history.map(h => {
                    let diffHtml = '-';
                    if (h.diff && h.diff.length > 0) {
                        diffHtml = '<table class="diff-table"><tr><th>Поле</th><th>Было</th><th>Стало</th></tr>' +
                            h.diff.map(d => `<tr><td>${d.field}</td><td>${JSON.stringify(d.old_value)}</td><td>${JSON.stringify(d.new_value)}</td></tr>`).join('') +
                            '</table>';
                    } else if (h.old_data && h.new_data) {
                        const diff = calculateDiff(h.old_data, h.new_data);
                        if (diff.length > 0) {
                            diffHtml = '<table class="diff-table"><tr><th>Поле</th><th>Было</th><th>Стало</th></tr>' +
                                diff.map(d => `<tr><td>${d.field}</td><td>${JSON.stringify(d.old_value)}</td><td>${JSON.stringify(d.new_value)}</td></tr>`).join('') +
                                '</table>';
                        }
                    } else if (h.old_data && !h.new_data) {
                        diffHtml = 'Удалено: ' + JSON.stringify(h.old_data);
                    } else if (!h.old_data && h.new_data) {
                        diffHtml = 'Создано: ' + JSON.stringify(h.new_data);
                    }
                    
                    return `
                    <tr>
                        <td>${h.item_id}</td>
                        <td>${h.action}</td>
                        <td>${h.user_id || '-'}</td>
                        <td>${new Date(h.changed_at).toLocaleString('ru-RU')}</td>
                        <td>${diffHtml}</td>
                    </tr>
                `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Нет записей</td></tr>';
            }
        } catch (error) {
        }
    }

    async function showItemHistory(itemId) {
        document.getElementById('historyItemId').value = itemId;
        loadHistory();
    }

    function calculateDiff(oldData, newData) {
        const diff = [];
        const allKeys = new Set([...Object.keys(oldData), ...Object.keys(newData)]);
        
        for (const key of allKeys) {
            const oldVal = oldData[key];
            const newVal = newData[key];
            
            if (oldVal !== newVal) {
                diff.push({
                    field: key,
                    old_value: oldVal !== undefined ? oldVal : null,
                    new_value: newVal !== undefined ? newVal : null
                });
            }
        }
        
        return diff;
    }

    async function exportHistory() {
        const params = new URLSearchParams();
        const itemId = document.getElementById('historyItemId').value;
        const userId = document.getElementById('historyUserId').value;
        const action = document.getElementById('historyAction').value;
        const from = document.getElementById('historyFrom').value;
        const to = document.getElementById('historyTo').value;

        if (itemId) params.append('item_id', itemId);
        if (userId) params.append('user_id', userId);
        if (action) params.append('action', action);
        if (from) params.append('from', new Date(from).toISOString());
        if (to) params.append('to', new Date(to).toISOString());

        try {
            const response = await fetch(`/api/history/export?${params}`, {
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                const text = await response.text().catch(() => '');
                if (text) {
                    try {
                        const parsed = JSON.parse(text);
                        if (parsed.error || parsed.Error) {
                            showMessage(parsed.error || parsed.Error, 'error');
                        }
                    } catch (e2) {
                        if (text) {
                            showMessage(text, 'error');
                        }
                    }
                }
                return;
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'history.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
        }
    }

    let messageTimeout = null;
    
    function showMessage(message, type) {
        if (!message) {
            return;
        }
        
        if (messageTimeout) {
            clearTimeout(messageTimeout);
            messageTimeout = null;
        }
        
        const appView = document.getElementById('appView');
        const loginView = document.getElementById('loginView');
        let messageDiv = null;
        
        if (appView && !appView.classList.contains('hidden')) {
            messageDiv = appView.querySelector('#message');
        } else if (loginView && !loginView.classList.contains('hidden')) {
            messageDiv = loginView.querySelector('#message');
        } else {
            messageDiv = document.getElementById('message');
        }
        
        if (messageDiv) {
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            const timeout = type === 'error' ? 10000 : 5000;
            messageTimeout = setTimeout(() => {
                messageDiv.style.display = 'none';
                messageTimeout = null;
            }, timeout);
        } else {
            console.error('Message:', message, 'Type:', type);
            alert(message);
        }
    }
</script>
</body>
</html>
